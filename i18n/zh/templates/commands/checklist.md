---
description: 根据用户需求为当前功能生成自定义清单。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json
  ps: scripts/powershell/check-prerequisites.ps1 -Json
---

## 检查清单的目的："对需求规格的单元测试"

**核心概念**：检查清单是**需求规格的单元测试**——它们验证某个领域的需求描述的质量、清晰度和完整性。

**不是用于验证/测试**：

- ❌ 不是"验证按钮是否正确点击"
- ❌ 不是"测试错误处理是否有效"
- ❌ 不是"确认 API 是否返回 200"
- ❌ 不是检查代码/实现是否匹配需求规格

**而是用于验证需求规格质量**：

- ✅ "是否为所有卡片类型定义了视觉层次的需求？"（完整性）
- ✅ "'突出显示'是否用具体的尺寸/位置进行了量化？"（清晰性）
- ✅ "所有交互元素的悬停状态需求是否一致？"（一致性）
- ✅ "是否为键盘导航定义了无障碍访问需求？"（覆盖性）
- ✅ "当图像加载失败时，需求规格是否定义了会发生什么？"（边界情况）

**比喻**：如果将你的规格视为用自然语言编写的代码，检查清单就是它的单元测试套件。你是在测试需求规格本身是否编写良好、完整、无歧义且已准备就绪可供实施 - 而不是测试实现是否有效。

## 用户输入

```text
$ARGUMENTS
```

（如果不为空）在进行之前，你**必须**考虑用户输入。

## 执行步骤

1. **设置**：从仓库根目录运行 `{SCRIPT}` 并解析 JSON 以获取 FEATURE_DIR 和 AVAILABLE_DOCS 。
   - 所有文件路径必须是绝对路径。
   - 对于参数中的单引号，如 "I'm Groot"，使用转义语法：例如 'I'\''m Groot'（尽可能使用双引号："I'm Groot"）。

2. **（动态地）澄清意图**：推导最多3个初始的上下文澄清问题（没有预设清单）。这些问题必须：
   - 由用户的表述和从 spec/plan/tasks 中提取的信号生成
   - 仅询问会实质性改变检查清单内容的信息
   - 如果已在 `$ARGUMENTS` 中明确，则单独跳过
   - 优先精确而非广度

   生成算法：
   1. 提取信号：特定领域关键词（例如认证、延迟、UX、API）、风险指标（"关键"、"必须"、"合规"）、利益干系人提示（"QA"、"评审"、"安全团队"）和明确的可交付成果（"无障碍访问"、"回滚"、"契约"）。
   2. 将信号聚类到候选重点领域（最多 4 个）并按相关性排序。
   3. 如果未明确说明，推断可能的受众与时机（作者、审查者、QA、发布）。
   4. 检测缺失维度：范围广度、深度/严格程度、风险侧重、排除边界、可衡量的验收标准。
   5. 从以下原型中选择并生成问题：
      - 范围细化（例如，"这应该包括与 X 和 Y 的集成接触点，还是仅限于本地模块正确性？"）
      - 风险优先级（例如，"哪些潜在风险领域应接受强制性的门禁检查？"）
      - 深度校准（例如，"这是一个轻量级的提交前的自查清单，还是一个正式发布的门禁？"）
      - 受众定位（例如，"这将仅由作者使用还是同行在 PR 审查时使用？"）
      - 边界排除（例如，"本轮是否应明确排除性能调优项？"）
      - 场景类别缺失（例如，"未检测到恢复流程 - 回滚/部分失败路径是否在范围内？"）

   问题格式化规则：
   - 如果呈现选项，生成一个紧凑的表格，包含列：选项 | 候选 | 为什么重要
   - 选项限制在 A–E 以内；如果自由形式的回答更清晰，则省略表格
   - 永远不要让用户重复他们已经说过的内容
   - 避免推测性类别（不要虚构）。如果不确定，明确询问："请确认 X 是否属于范围。"

   当无法交互时的默认值：
   - 深度：标准
   - 受众：如果与代码相关则为评审者（PR）；否则为作者
   - 侧重：前 2 个相关性聚类

   输出问题（标记为 Q1/Q2/Q3）。获得答案后：如果仍有 ≥2 个场景类别（备用/异常/恢复/非功能性领域）不明确，你**可以**再提出最多2个针对性后续问题（Q4/Q5），每个问题附带一行理由（例如，"未解决的恢复路径风险"）。问题总数不超过5个。如果用户明确拒绝，则不再追加提问。。

3. **理解用户请求**：合并 `$ARGUMENTS` + 澄清答案：
   - 推导检查清单主题（例如，安全、评审、部署、ux）
   - 整合被用户提到的明确必须包含条目
   - 将侧重点选择映射到类别框架
   - 从 spec/plan/tasks 中推断任何缺失的上下文（不要虚构）

4. **加载功能上下文**：从 FEATURE_DIR 中读取：
   - spec.md：功能需求和范围
   - plan.md（如果存在）：技术细节、依赖项
   - tasks.md（如果存在）：实施任务

   **上下文加载策略**：
   - 仅加载与当前关注领域相关的必要部分（避免转储整个文件）
   - 优先将长章节总结为简洁的场景/需求项
   - 使用渐进式披露：仅在检测到缺失时添加后续检索
   - 如果源文档很大，生成临时摘要项，而不是嵌入原始文本

5. **生成检查清单** - 创建"需求规格的单元测试"：
   - 如果 `FEATURE_DIR/checklists/` 目录不存在，则创建它
   - 生成唯一的检查清单文件名：
     - 使用基于领域描述的简短名称（例如，`ux.md`、`api.md`、`security.md`）
     - 格式：`[domain].md`
     - 如果文件存在，追加到现有文件
   - 从 CHK001 开始顺序编号项目
   - 每次运行 `/speckit.checklist` 都创建一个新文件（绝不覆盖现有的检查清单）

   **核心原则 - 测试需求规格，而不是测试实现**：
   每个检查清单的条目必须是评估**需求本身**：
   - **完整性**：所有必需的需求都存在吗？
   - **清晰性**：需求无歧义且具体吗？
   - **一致性**：需求之间是否相互一致吗？
   - **可衡量性**：可以客观验证需求吗？
   - **覆盖性**：所有场景/边界情况都考虑了吗？

   **类别的描述结构** - 按需求质量维度分组：
   - **需求完整性**（是否记录了所有必需的需求？）
   - **需求清晰性**（需求是否具体且无歧义吗？）
   - **需求一致性**（需求是否一致且无冲突吗？）
   - **验收标准质量**（成功标准是否可衡量吗？）
   - **场景覆盖性**（是否涵盖了所有流程/用例？）
   - **边界情况覆盖性**（是否定义了边界条件？）
   - **非功能性需求**（性能、安全、无障碍访问等——是否已规定？）
   - **依赖项与假设**（它们是否已经记录并验证了吗？）
   - **模糊性与冲突**（哪些需要澄清？）

   **如何编写检查清单条目 - "需求规格的单元测试"**：

   ❌ **错误**（测试实现）：
   - "验证登陆页显示 3 个剧集卡片"
   - "测试在桌面端的悬停状态是否有效"
   - "确认点击logo是否导航到首页"

   ✅ **正确**（测试需求质量）：
   - “是否已明确规定了推荐剧集的确切数量和布局？”[完整性]
   - “‘突出显示’是否用具体的尺寸/位置进行了量化？”[清晰性]
   - “所有交互元素的悬停状态的需求是否一致？”[一致性]
   - “是否为所有交互式 UI 定义了键盘导航需求？”[覆盖性]
   - “规格是否定义了logo图片加载失败时的回退行为？”[边界情况]
   - “是否为异步剧集的数据定义了加载状态需求？”[完整性]
   - “规格是否为相互竞争的 UI 元素定义了视觉层级？”[清晰性]

   **项目结构**：
   每个项目应遵循此模式：
   - 使用疑问句形式，询问需求质量
   - 关注在 spec/plan 中已编写（或未编写）的内容
   - 在方括号中包含质量维度 [完整性/清晰性/一致性等]
   - 检查现有需求引用的规格章节 `[规格 §X.Y]`
   - 检查缺失需求时使用 `[缺失]` 标记

   **按质量维度的示例**：

   完整性：
   - "是否为所有 API 失败模式定义了错误处理需求？"[缺失]
   - "是否为所有交互元素指定了无障碍访问需求？"[完整性]
   - "是否为响应式布局定义了移动断点需求？"[缺失]

   清晰性：
   - "‘快速加载’是否用具体的时间阈值进行了量化？"[清晰性, 规格 §NFR-2]
   - "‘相关剧集’的选择标准是否明确定义？"[清晰性, 规格 §FR-5]
   - "‘突出’是否用可衡量的视觉属性定义？"[模糊, 规格 §FR-4]

   一致性：
   - "所有页面的导航需求是否一致？"[一致性, 规格 §FR-10]
   - "卡片组件的需求在登陆页和详情页之间是否一致？"[一致性]

   覆盖性：
   - "是否为零状态场景（没有剧集）定义了需求？"[覆盖性, 边界情况]
   - "是否考虑了并发用户的交互场景？"[覆盖性, 缺失]
   - "是否为部分数据加载失败定义了需求？"[覆盖性, 异常流程]

   可衡量性：
   - "视觉层次的需求是否可衡量/可测试？"[验收标准, 规格 §FR-1]
   - "‘视觉平衡’能否被客观验证？"[可衡量性, 规格 §FR-2]

   **场景分类和覆盖性**（侧重需求质量）：
   - 检查以下类别的需求是否存在：主要场景、备用场景、异常/错误场景、恢复场景、非功能性场景
   - 对每个场景类别，询问："[场景类型]需求是否完整、清晰且一致？"
   - 如果某个场景类别缺失："[场景类型]需求是被有意排除还是缺失？"[缺失]
   - 在发生状态变更时，包含弹性/回滚："是否为迁移失败定义了回滚需求？"[缺失]

   **可追溯性要求**：
   - 最低限度：≥80%的项目必须包含至少一个可追溯性引用
   - 每个条目都应引用规格章节 `[规格 §X.Y]`，或使用以下标记之一：`[缺失]`、`[模糊]`、`[冲突]`、`[假设]`
   - 如果不存在 ID 系统："是否为需求和验收标准建立了 ID 方案？"[可追溯性]

   **发现并解决问题**（需求质量问题）：
   询问有关需求本身的问题：
   - 模糊："‘快速’一词是否用具体指标进行了量化？"[模糊, 规格 §NFR-1]
   - 冲突："§FR-10 和 §FR-10a 中的导航需求是否冲突？"[冲突]
   - 假设："'播客 API 始终可用'的假设是否经过验证？"[假设]
   - 依赖："外部的播客 API 需求是否已经文档化了？"[依赖, 偏差]
   - 缺失："'视觉层次'的需求是否定义了可衡量的标准？"[缺失]

   **内容整合**：
   - 软上限：如果原始候选项目 > 40，按风险/影响优先级排序
   - 合并检查有着相同方面需求的近似重复项
   - 如果 >5 个低影响的边界情况，创建一个条目："需求中是否考虑到如下边界情况: X、Y、Z？"[覆盖性]

   **🚫 绝对禁止** - 以下这些会使它变成测试实现，而非测试需求：
   - ❌ 任何以"验证"、"测试"、"确认"、"检查" + 实现行为开头的条目
   - ❌ 提及代码执行、用户操作、系统行为
   - ❌ "显示正确"、"正常工作"、"按预期运行"
   - ❌ "点击"、"导航"、"渲染"、"加载"、"执行"
   - ❌ 测试用例、测试计划、QA 流程
   - ❌ 实现细节（框架、API、算法）

   **✅ 必需模式** - 以下这些是测试需求质量：
   - ✅ "是否为[场景]定义/规定/记录了[需求类型]？"
   - ✅ "[模糊术语]是否用具体标准进行了量化/澄清？？"
   - ✅ "[章节A]和[章节B]的需求是否一致？"
   - ✅ "[需求]能否被客观衡量/验证？？"
   - ✅ "需求中是否涵盖了[边界情况/场景]？"
   - ✅ "该规格是否定义[缺失的方面]？"

6. **结构引用**：使用 `templates/checklist-template.md` 作为规范模板生成检查清单，包含标题、元信息部分、类别标题和 ID 格式。如果模板不可用，请使用：H1 标题、目的/创建的元信息行、包含 `- [ ] CHK### <需求条目>` 行的 `##` 类别章节，ID 从 CHK001 开始全局递增。

7. **报告**：输出已生成的检查清单的完整路径、项目数量，并提醒用户每次运行都会创建新文件。总结：
   - 选定的重点领域
   - 深度级别
   - 参与者/时机
   - 已纳入的任何用户指定的明确必须包含项

**重要**：每次调用 `/speckit.checklist` 命令都会为清单文件创建一个基于领域描述的简短名称，除非文件已存在。这允许：

- 创建多种类型的检查清单（例如，`ux.md`、`test.md`、`security.md`）
- 简单、易记的文件名，说明检查清单目的
- 在 `checklists/` 文件夹中轻松识别并导航

为避免混乱，请使用描述性类型，并在完成后清理过时的检查清单。

## 示例检查清单类型及其条目

**UX 需求质量：** `ux.md`

示例条目（测试需求，而非实现需求）：

- "'视觉层次'的需求是否定义了可衡量的标准？"[清晰性, 规格 §FR-1]
- "UI 元素的数量和定位是否明确指定？"[完整性, 规格 §FR-1]
- "交互状态需求（悬停、焦点、活动）的定义是否一致？"[一致性]
- "是否为所有交互元素指定了无障碍访问需求？"[覆盖性, 缺失]
- "当图像加载失败时是否定义了回退行为？"[边界情况, 偏差]
- "‘突出显示’能否被客观衡量？"[可衡量性, 规格 §FR-4]

**API 需求质量：** `api.md`

示例项目：

- "是否为所有失败场景指定了错误响应格式？"[完整性]
- "速率限制需求是否用具体阈值进行了量化？"[清晰性]
- "所有端点的认证需求是否一致？"[一致性]
- "是否为外部依赖项定义了重试/超时需求？"[覆盖性, 缺失]
- "版本控制策略是否在需求中记录？"[缺失]

**性能需求质量：** `performance.md`

示例项目：

- "性能需求是否用具体指标进行了量化？"[清晰性]
- "是否为所有关键用户旅程定义了性能目标？"[覆盖性]
- "是否规定了不同负载条件下的性能需求？"[完整性]
- "性能需求能否被客观衡量？"[可衡量性]
- "是否为高负载场景定义了降级需求？"[边界情况, 缺失]

**安全需求质量：** `security.md`

示例项目：

- "是否为所有受保护资源规定了认证需求？"[覆盖性]
- "是否为敏感信息定义了数据保护需求？"[完整性]
- "威胁模型是否已记录且需求与之对齐？"[可追溯性]
- "安全需求是否符合合规义务？"[一致性]
- "是否定义了安全故障/入侵响应需求？？"[缺失, 异常流程]

## 反例：不要做什么

**❌ 错误 - 以下这些是测试实现，而不是测试需求质量：**

```markdown
- [ ] CHK001 - 验证登录页显示 3 个剧集卡片 [规格 §FR-001]
- [ ] CHK002 - 测试桌面端的悬停状态是否正确工作 [规格 §FR-003]
- [ ] CHK003 - 确认点击logo导航到首页 [规格 §FR-010]
- [ ] CHK004 - 检查*相关剧集*区域显示 3-5 个条目 [规格 §FR-005]
```

**✅ 正确 - 以下这些测试需求质量：**

```markdown
- [ ] CHK001 - 是否已明确规定了功能片段（episode）的确切数量和布局？"[完整性, 规格 §FR-001]
- [ ] CHK002 - 所有交互元素的悬停状态的需求是否一致？"[一致性, 规格 §FR-003]
- [ ] CHK003 - 所有可点击品牌元素的导航需求是否清晰？"[清晰性, 规格 §FR-010]
- [ ] CHK004 - 相关功能片段（episode）的选择标准是否记录？"[缺失, 规格 §FR-005]
- [ ] CHK005 - 是否为异步片段（episode）的数据定义了加载状态需求？？"[缺失]
- [ ] CHK006 - 能否客观衡量"视觉层级"需求？"[可衡量性, 规格 §FR-001]
```

**关键区别：**

- 错误：测试系统是否正常工作
- 正确：测试需求是否编写正确
- 错误：对行为的验证
- 正确：对需求质量的验证
- 错误："它是否做了 X 吗？"
- 正确："X 是否被明确规定了吗？"
