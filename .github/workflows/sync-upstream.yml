name: åŒæ­¥ä¸Šæ¸¸ä»“åº“

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: "0 0 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: false
        default: "main"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    concurrency:
      group: upstream-sync-${{ github.ref }}
      cancel-in-progress: false
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“
        run: |
          git remote add upstream https://github.com/github/spec-kit.git || true
          git fetch upstream --tags --force

      - name: è¯»å–åŒæ­¥å¿½ç•¥æ¸…å•
        id: read_syncignore
        run: |
          if [ -f .github/.syncignore ]; then
            # è¯»å–å¿½ç•¥æ¸…å•ï¼Œè¿‡æ»¤æ‰æ³¨é‡Šå’Œç©ºè¡Œ
            IGNORE_PATTERNS=$(grep -v '^#' .github/.syncignore | grep -v '^$' | tr '\n' '|' | sed 's/|$//')
            echo "patterns=$IGNORE_PATTERNS" >> $GITHUB_OUTPUT
            echo "has_patterns=true" >> $GITHUB_OUTPUT
            echo "è¯»å–åˆ°çš„å¿½ç•¥æ¨¡å¼: $IGNORE_PATTERNS"
          else
            echo "has_patterns=false" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ° .syncignore æ–‡ä»¶"
          fi

      - name: æ£€æŸ¥ä¸Šæ¸¸å˜æ›´
        id: check_changes
        run: |
          # è·å–å½“å‰çš„ HEAD commit
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT

          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šæ¸¸çš„æ–°æäº¤éœ€è¦åˆå¹¶
          # ä½¿ç”¨ merge-base æ‰¾åˆ°å…±åŒç¥–å…ˆï¼Œç„¶åæ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°æäº¤
          MERGE_BASE=$(git merge-base HEAD upstream/main)
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT

          if [ "$MERGE_BASE" = "$UPSTREAM_COMMIT" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No upstream changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # æ„å»º git æ’é™¤è·¯å¾„å‚æ•°
            EXCLUDE_ARGS=""
            if [ "${{ steps.read_syncignore.outputs.has_patterns }}" = "true" ]; then
              # ä» .syncignore è¯»å–æ¨¡å¼å¹¶è½¬æ¢ä¸º git pathspec æ’é™¤å‚æ•°
              while IFS= read -r pattern; do
                # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
                [[ "$pattern" =~ ^#.*$ ]] && continue
                [[ -z "$pattern" ]] && continue
                EXCLUDE_ARGS="$EXCLUDE_ARGS ':!${pattern}'"
              done < .github/.syncignore
            fi

            # è·å–ä¸Šæ¸¸æ–°æäº¤çš„å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼ˆåº”ç”¨å¿½ç•¥æ¸…å•ï¼‰
            ALL_CHANGED=$(git diff --name-only $MERGE_BASE upstream/main)
            if [ "${{ steps.read_syncignore.outputs.has_patterns }}" = "true" ]; then
              IGNORE_PATTERN="${{ steps.read_syncignore.outputs.patterns }}"
              CHANGED_FILES=$(echo "$ALL_CHANGED" | grep -vE "($IGNORE_PATTERN)" | head -20)
            else
              CHANGED_FILES="$ALL_CHANGED"
            fi
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # è·å–å˜æ›´ç»Ÿè®¡ï¼ˆåº”ç”¨å¿½ç•¥æ¸…å•ï¼‰
            if [ -n "$EXCLUDE_ARGS" ]; then
              STATS=$(eval git diff --stat $MERGE_BASE upstream/main -- . $EXCLUDE_ARGS)
            else
              STATS=$(git diff --stat $MERGE_BASE upstream/main)
            fi
            echo "stats<<EOF" >> $GITHUB_OUTPUT
            echo "$STATS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "Upstream changes detected!"
          fi

      - name: ä¿å­˜å®Œæ•´å·®å¼‚æŠ¥å‘Š
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          mkdir -p sync-report
          git log --oneline --decorate --graph --left-right --cherry-pick --no-merges HEAD...upstream/main > sync-report/commits.txt

          # æ„å»º git æ’é™¤è·¯å¾„å‚æ•°
          EXCLUDE_ARGS=""
          if [ -f .github/.syncignore ]; then
            while IFS= read -r pattern; do
              [[ "$pattern" =~ ^#.*$ ]] && continue
              [[ -z "$pattern" ]] && continue
              EXCLUDE_ARGS="$EXCLUDE_ARGS ':!${pattern}'"
            done < .github/.syncignore
          fi

          # ç”Ÿæˆå·®å¼‚æŠ¥å‘Šï¼ˆåº”ç”¨å¿½ç•¥æ¸…å•ï¼‰
          if [ -n "$EXCLUDE_ARGS" ]; then
            eval git diff HEAD upstream/main -- . $EXCLUDE_ARGS > sync-report/full.diff
            eval git diff --name-status HEAD upstream/main -- . $EXCLUDE_ARGS > sync-report/changed-files.txt
          else
            git diff HEAD upstream/main > sync-report/full.diff
            git diff --name-status HEAD upstream/main > sync-report/changed-files.txt
          fi
        shell: bash

      - name: ä¸Šä¼ åŒæ­¥æŠ¥å‘Š
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: upstream-sync-report
          path: sync-report

      - name: åˆå¹¶ä¸Šæ¸¸å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # å°è¯•åˆå¹¶ upstream çš„å˜æ›´
          # é¦–å…ˆè·å–å…±åŒçš„ç¥–å…ˆæäº¤
          MERGE_BASE=$(git merge-base HEAD upstream/main)

          # åˆå¹¶ä¸Šæ¸¸å˜æ›´
          if git merge $MERGE_BASE upstream/main --no-edit --strategy=recursive --strategy-option=theirs; then
            # æ¢å¤ .syncignore ä¸­åˆ—å‡ºçš„æ‰€æœ‰æœ¬åœ°æ–‡ä»¶
            if [ -f .github/.syncignore ]; then
              echo "æ¢å¤å¿½ç•¥æ¸…å•ä¸­çš„æœ¬åœ°æ–‡ä»¶..."
              while IFS= read -r pattern; do
                # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
                [[ "$pattern" =~ ^#.*$ ]] && continue
                [[ -z "$pattern" ]] && continue
                
                # æ¢å¤åŒ¹é…æ¨¡å¼çš„æ–‡ä»¶
                git checkout HEAD -- "$pattern" 2>/dev/null || true
                git add "$pattern" 2>/dev/null || true
              done < .github/.syncignore
              
              # å¦‚æœæœ‰å˜æ›´ï¼Œä¿®æ­£åˆå¹¶æäº¤
              if ! git diff --cached --quiet; then
                git commit --amend --no-edit
              fi
            fi
            echo "merge_status=success" >> $GITHUB_ENV
            git push origin main
          else
            echo "merge_status=conflict" >> $GITHUB_ENV
            git merge --abort
          fi

      - name: åŒæ­¥ä¸Šæ¸¸æ ‡ç­¾
        run: |
          # æ¨é€ä»ä¸Šæ¸¸è·å–çš„æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
          # --tags ä¼šæ¨é€æ‰€æœ‰ä¸åœ¨è¿œç¨‹ä»“åº“çš„æ ‡ç­¾
          git push origin --tags || echo "æ ‡ç­¾åŒæ­¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

      - name: åˆ›å»ºå†²çªå¤„ç†åˆ†æ”¯
        if: steps.check_changes.outputs.has_changes == 'true' && env.merge_status == 'conflict'
        run: |
          BRANCH="upstream-sync-${{ steps.check_changes.outputs.upstream_commit }}"
          git checkout -b "$BRANCH"
          # é‡æ–°å°è¯•ä»¥ä¾¿ç”Ÿæˆå†²çªçŠ¶æ€åˆ°åˆ†æ”¯ï¼ˆä¸æ¨é€å¤±è´¥åˆå¹¶ï¼‰
          set +e
          git merge upstream/main --no-edit
          set -e
          git push --set-upstream origin "$BRANCH"

      - name: åˆ›å»ºæ‹‰å–è¯·æ±‚
        if: steps.check_changes.outputs.has_changes == 'true' && env.merge_status == 'conflict'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: upstream-sync-${{ steps.check_changes.outputs.upstream_commit }}
          title: "â¬†ï¸ åŒæ­¥ä¸Šæ¸¸å˜æ›´ï¼ˆå­˜åœ¨å†²çªï¼‰: ${{ steps.check_changes.outputs.upstream_commit }}"
          body: |
            è‡ªåŠ¨åˆ›å»ºçš„å†²çªå¤„ç†åˆ†æ”¯ï¼Œè¯·åœ¨ PR ä¸­è§£å†³ä¸ upstream/main çš„å†²çªã€‚

            - è¿è¡Œè¯¦æƒ…ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - ä¸Šæ¸¸æäº¤ï¼š${{ steps.check_changes.outputs.upstream_commit }}
          labels: upstream-sync, merge-conflict

      - name: æ¸²æŸ“æ±‰åŒ–å¾…åŠ issue æ¨¡æ¿
        id: render_localization_issue
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          UPSTREAM_COMMIT: ${{ steps.check_changes.outputs.upstream_commit }}
          CURRENT_COMMIT: ${{ steps.check_changes.outputs.current_commit }}
          MERGE_STATUS: ${{ env.merge_status == 'success' && 'âœ… æˆåŠŸ' || 'âš ï¸ å†²çªï¼ˆéœ€è¦æ‰‹åŠ¨å¤„ç†ï¼‰' }}
          UPDATED_AT: ${{ github.event.repository.updated_at }}
          STATS: ${{ steps.check_changes.outputs.stats }}
          CHANGED_FILES: ${{ steps.check_changes.outputs.changed_files }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        run: |
          python3 .github/workflows/scripts/render_localization_issue.py

      - name: åˆ›å»ºæ±‰åŒ–å¾…åŠ issue
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ğŸ“ æ±‰åŒ–å¾…åŠï¼šåŒæ­¥ä¸Šæ¸¸ä»“åº“å˜æ›´ (${{ steps.check_changes.outputs.upstream_commit }})"
          content-filepath: .github/workflows/scripts/localization-issue-output.md
          labels: |
            upstream-sync
            localization-todo
            ${{ env.merge_status == 'conflict' && 'merge-conflict' || '' }}
